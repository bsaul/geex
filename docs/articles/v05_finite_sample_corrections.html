<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finite sample correction API in <code>geex</code> • geex</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">geex</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bsaul/geex">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Finite sample correction API in <code>geex</code>
</h1>
                        <h4 class="author">Bradley Saul</h4>
            
            <h4 class="date">2018-05-28</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The empirical sandwich variance estimator is known to underestimate <span class="math inline">\(V(\theta)\)</span> in small samples <span class="citation">(Fay and Graubard 2001)</span>. Particularly in the context of GEE, <a href="https://bsaul.github.io/geex/articles/articles/mestimation_bib.html">many authors</a> have proposed corrections that modify components of <span class="math inline">\(\hat{\Sigma}\)</span> and/or by assuming <span class="math inline">\(\hat{\theta}\)</span> follows a <span class="math inline">\(t\)</span> (or <span class="math inline">\(F\)</span>), as opposed to Normal, distribution with some estimated degrees of freedom. Many of the proposed corrections somehow modify a combination of the <span class="math inline">\(A_i\)</span>, <span class="math inline">\(A_m\)</span>, <span class="math inline">\(B_i\)</span>, or <span class="math inline">\(B_m\)</span> matrices.</p>
<p><code>geex</code> provides an API that allows users to specify functions that utilize these matrices to form corrections. A finite sample correction function at a minimum takes the argument <code>components</code>, which is an object of class <code>sandwich_components</code>. For example,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">correct_by_nothing &lt;-<span class="st"> </span><span class="cf">function</span>(components){
  A &lt;-<span class="st"> </span><span class="kw"><a href="../reference/grab_bread-methods.html">grab_bread</a></span>(components)
  B &lt;-<span class="st"> </span><span class="kw"><a href="../reference/grab_meat-methods.html">grab_meat</a></span>(components)
  <span class="kw"><a href="../reference/compute_sigma.html">compute_sigma</a></span>(<span class="dt">A =</span> A, <span class="dt">B =</span> B)
}</code></pre></div>
<p>is a correctly formed function that does no corrections. Additional arguments may also be specified, as shown in the example.</p>
</div>
<div id="corrections-included-with-geex" class="section level2">
<h2 class="hasAnchor">
<a href="#corrections-included-with-geex" class="anchor"></a>Corrections included with <code>geex</code>
</h2>
<p>The <code>geex</code> package includes the bias correction and degrees of freedom corrections proposed by <span class="citation">Fay and Graubard (2001)</span> in the <code>correct_by_fay_bias</code> and <code>correct_by_fay_df</code> functions respectively. The following demonstrates the construction and use of the bias correction. <span class="citation">Fay and Graubard (2001)</span> proposed the modified variance estimator <span class="math inline">\(\hat{\Sigma}^{bc}(b) = A_m^{-1} B_m^{bc}(b) \{A_m^{-1}\}^{\intercal}/m\)</span>, where:</p>
<span class="math display">\[\begin{equation}
\label{eq:bc}
B^{bc}_m(b) = \sum_{i = 1}^m H_i(b) B_i H_i(b)^{\intercal},
\end{equation}\]</span>
<span class="math display">\[\begin{equation}
\label{eq:H}
H_i(b) = \{1 - \min(b, \{A_i A^{-1}\}_{jj}) \}^{-1/2},
\end{equation}\]</span>
<p>and <span class="math inline">\(W_{jj}\)</span> is the <span class="math inline">\((j, j)\)</span> element of a matrix <span class="math inline">\(W\)</span>. When <span class="math inline">\(\{A_i A^{-1}\}_{jj}\)</span> is close to 1, the adjustment to <span class="math inline">\(\hat{\Sigma}^{bc}(b)\)</span> may be extreme, and the constant <span class="math inline">\(b\)</span> is chosen by the analyst to limit over adjustments.</p>
</div>
<div id="bias-correction-example" class="section level2">
<h2 class="hasAnchor">
<a href="#bias-correction-example" class="anchor"></a>Bias correction example</h2>
<p>The bias corrected estimator <span class="math inline">\(\hat{\Sigma}^{bc}(b)\)</span> can be implemented in <code>geex</code> by the following function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bias_correction &lt;-<span class="st"> </span><span class="cf">function</span>(components, b){
  A &lt;-<span class="st"> </span><span class="kw"><a href="../reference/grab_bread-methods.html">grab_bread</a></span>(components)
  A_i &lt;-<span class="st"> </span><span class="kw"><a href="../reference/grab_bread_list-methods.html">grab_bread_list</a></span>(components)
  B_i &lt;-<span class="st"> </span><span class="kw"><a href="../reference/grab_meat_list-methods.html">grab_meat_list</a></span>(components)
  Ainv &lt;-<span class="st"> </span><span class="kw">solve</span>(A)

  H_i &lt;-<span class="st"> </span><span class="kw">lapply</span>(A_i, <span class="cf">function</span>(m){
    <span class="kw">diag</span>( (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">pmin</span>(b, <span class="kw">diag</span>(m <span class="op">%*%</span><span class="st"> </span>Ainv) ) )<span class="op">^</span>(<span class="op">-</span><span class="fl">0.5</span>) )
  })

  Bbc_i &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(B_i), <span class="cf">function</span>(i){
    H_i[[i]] <span class="op">%*%</span><span class="st"> </span>B_i[[i]] <span class="op">%*%</span><span class="st"> </span>H_i[[i]]
  })
  Bbc   &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">simplify2array</span>(Bbc_i), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, sum)

  <span class="kw"><a href="../reference/compute_sigma.html">compute_sigma</a></span>(<span class="dt">A =</span> A, <span class="dt">B =</span> Bbc)
}</code></pre></div>
<p>The <code>compute_sigma</code> function simply computes <span class="math inline">\(A^{-1} B \{A^{-1}\}^{\intercal}\)</span>. Note that <code>geex</code> computes <span class="math inline">\(A_m\)</span> and <span class="math inline">\(B_m\)</span> as the sums of <span class="math inline">\(A_i\)</span> and <span class="math inline">\(B_i\)</span> rather than the means, hence the appropriate function in the <code>apply</code> call is <code>sum</code> and not <code>mean</code>. To use this bias correction, the <code>m_estimate</code> function accepts a named list of corrections to perform. Each element of the list is also a list with two elements: <code>correctFUN</code>, the correction function; and <code>correctFUN_control</code>, a list of arguments passed to the <code>correctFUN</code> besides <code>A</code>, <code>A_i</code>, <code>B</code>, and <code>B_i</code>.</p>
</div>
<div id="comparision-to-saws-package" class="section level2">
<h2 class="hasAnchor">
<a href="#comparision-to-saws-package" class="anchor"></a>Comparision to saws package</h2>
<p>Here we compare the <code>geex</code> implementation of GEE with an exchangeable correlation matrix to Fay’s <code>saws</code> package.</p>
<p>The estimating functions are:</p>
<span class="math display">\[\begin{equation}
\label{gee}
\sum_{i= 1}^m \psi(\mathbf{Y}_i, \mathbf{X}_i, \beta) = \sum_{i = 1}^m \mathbf{D}_i^{\intercal} \mathbf{V}_i^{-1} (\mathbf{Y}_i - \mathbf{\mu}(\beta)) = 0
\end{equation}\]</span>
<p>where <span class="math inline">\(\mathbf{D}_i = \partial \mathbf{\mu}/\partial \mathbf{\beta}\)</span>. The covariance matrix is modeled by <span class="math inline">\(\mathbf{V}_i = \phi \mathbf{A}_i^{0.5} \mathbf{R}(\alpha) \mathbf{A}_i^{0.5}\)</span>. The matrix <span class="math inline">\(\mathbf{R}(\alpha)\)</span> is the “working” correlation matrix, which in this example is an exchangeable matrix with off diagonal elements <span class="math inline">\(\alpha\)</span>. The matrix <span class="math inline">\(\mathbf{A}_i\)</span> is a diagonal matrix with elements containing the variance functions of <span class="math inline">\(\mu\)</span>. The equations in  can be translated into an <code>eeFUN</code> as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gee_eefun &lt;-<span class="st"> </span><span class="cf">function</span>(data, formula, family){
  X &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="dt">object =</span> formula, <span class="dt">data =</span> data)
  Y &lt;-<span class="st"> </span><span class="kw">model.response</span>(<span class="kw">model.frame</span>(<span class="dt">formula =</span> formula, <span class="dt">data =</span> data))
  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(X)
  <span class="cf">function</span>(theta, alpha, psi){
    mu  &lt;-<span class="st"> </span>family<span class="op">$</span><span class="kw">linkinv</span>(X <span class="op">%*%</span><span class="st"> </span>theta)
    Dt  &lt;-<span class="st"> </span><span class="kw">t</span>(X) <span class="op">%*%</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">as.numeric</span>(mu), <span class="dt">nrow =</span> n)
    A   &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">as.numeric</span>(family<span class="op">$</span><span class="kw">variance</span>(mu)), <span class="dt">nrow =</span> n)
    R   &lt;-<span class="st"> </span><span class="kw">matrix</span>(alpha, <span class="dt">nrow =</span> n, <span class="dt">ncol =</span> n)
    <span class="kw">diag</span>(R) &lt;-<span class="st"> </span><span class="dv">1</span>
    V   &lt;-<span class="st"> </span>psi <span class="op">*</span><span class="st"> </span>(<span class="kw">sqrt</span>(A) <span class="op">%*%</span><span class="st"> </span>R <span class="op">%*%</span><span class="st"> </span><span class="kw">sqrt</span>(A))
    Dt <span class="op">%*%</span><span class="st"> </span><span class="kw">solve</span>(V) <span class="op">%*%</span><span class="st"> </span>(Y <span class="op">-</span><span class="st"> </span>mu)
  }
}</code></pre></div>
<p>This <code>eeFUN</code> treats the correlation parameter <span class="math inline">\(\alpha\)</span> and scale parameter <span class="math inline">\(\phi\)</span> as fixed, though some estimation algorithms use an iterative procedure that alternates between estimating <span class="math inline">\(\beta\)</span> and these parameters. By customizing the root finding function, such an algorithm could be implemented using <code>geex</code> [see <code>vignette("geex_root_solvers")</code> for more information].</p>
<p>We use this example to compare covariance estimates obtained from the <code>gee</code> function, so root finding computations are turned off. The <code>gee</code> <span class="math inline">\(\beta\)</span> estimates are used instead. Estimates for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\phi\)</span> are also extracted from the <code>gee</code> results in <code>m_estimate</code>. This example shows that an <code>eeFUN</code> can accept additional arguments to be passed to either the outer (data) function or the inner (theta) function. Unlike previous examples, the independent units are the types of wool, which is set in <code>m_estimate</code> by the <code>units</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span>gee<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/gee/topics/gee">gee</a></span>(breaks<span class="op">~</span>tension, <span class="dt">id=</span>wool, <span class="dt">data=</span>warpbreaks, <span class="dt">corstr=</span><span class="st">"exchangeable"</span>)
guo &lt;-<span class="st"> </span>saws<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/saws/topics/geeUOmega">geeUOmega</a></span>(g)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(geex)
results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/m_estimate.html">m_estimate</a></span>(
  <span class="dt">estFUN =</span> gee_eefun, <span class="dt">data  =</span> warpbreaks, 
  <span class="dt">units =</span> <span class="st">'wool'</span>, <span class="dt">roots =</span> <span class="kw">coef</span>(g), <span class="dt">compute_roots =</span> <span class="ot">FALSE</span>,
  <span class="dt">outer_args =</span> <span class="kw">list</span>(<span class="dt">formula =</span> breaks <span class="op">~</span><span class="st"> </span>tension, 
                      <span class="dt">family  =</span> <span class="kw">gaussian</span>()),
  <span class="dt">inner_args =</span> <span class="kw">list</span>(<span class="dt">alpha   =</span> g<span class="op">$</span>working.correlation[<span class="dv">1</span>,<span class="dv">2</span>], 
                      <span class="dt">psi     =</span> g<span class="op">$</span>scale), 
  <span class="dt">corrections =</span> <span class="kw">list</span>(
   <span class="dt">bias_correction_.1 =</span> <span class="kw"><a href="../reference/correction.html">correction</a></span>(bias_correction, <span class="dt">b =</span> .<span class="dv">1</span>),
   <span class="dt">bias_correction_.3 =</span> <span class="kw"><a href="../reference/correction.html">correction</a></span>(bias_correction, <span class="dt">b =</span> .<span class="dv">3</span>))) </code></pre></div>
<p>In the <code>geex</code> output, the item <code>corrections</code> contains a list of the results of computing each item in the <code>corrections_list</code>. Comparing the <code>geex</code> results to the results of the <code><a href="http://www.rdocumentation.org/packages/saws/topics/geeUOmega">saws::geeUOmega</a></code> function, the maximum difference in the results for any of corrected estimated covariance matrices is 1.1e-09.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-fay2001">
<p>Fay, Michael P., and Barry I. Graubard. 2001. <em>Small-Sample Adjustments for Wald-Type Tests Using Sandwich Estimators</em> 57.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#corrections-included-with-geex">Corrections included with <code>geex</code></a></li>
      <li><a href="#bias-correction-example">Bias correction example</a></li>
      <li><a href="#comparision-to-saws-package">Comparision to saws package</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bradley Saul.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
